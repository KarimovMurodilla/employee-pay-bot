{% extends "sqladmin/layout.html" %}

{% block content %}
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #f4f7f9;
        color: #333;
    }
    .stats-container {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 25px;
    }
    h1 {
        color: #2c3e50;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 2.2em;
    }
    h2 {
        color: #2c3e50;
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 10px;
        margin-top: 20px;
    }
    p, li {
        font-size: 1.1em;
        line-height: 1.6;
    }
    .stat-box {
        background-color: #ecf0f1;
        border-left: 5px solid #3498db;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    .chart-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 25px;
    }
    .download-section {
        margin-top: 30px;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        text-align: center;
    }
    .download-btn {
        display: inline-block;
        padding: 12px 25px;
        margin: 5px;
        background-color: #2ecc71;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        font-weight: bold;
        transition: background-color 0.3s ease;
        border: none;
        cursor: pointer;
    }
    .download-btn:hover {
        background-color: #27ae60;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th, td {
        padding: 12px 15px;
        border: 1px solid #ddd;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
        font-weight: bold;
        color: #333;
    }
    tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    tbody tr:hover {
        background-color: #f1f1f1;
    }
</style>

<div class="stats-container">
    <h1>üìä –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
    <div class="stat-box">
        <p><strong>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong> {{ total_users }}</p>
    </div>
    <div class="stat-box">
        <p><strong>–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã:</strong> {{ "%.2f"|format(total_spending) }} UZS</p>
    </div>
    <div class="stat-box">
        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π:</strong> {{ active_establishments }}</p>
    </div>
</div>

<div class="stats-container">
    <h2>üè¢ –†–∞—Å—Ö–æ–¥—ã –ø–æ –æ—Ç–¥–µ–ª–∞–º</h2>
    <table>
        <thead>
            <tr>
                <th>–û—Ç–¥–µ–ª</th>
                <th>–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</th>
            </tr>
        </thead>
        <tbody>
            {% for dept, spending in department_spending %}
            <tr>
                <td>{{ dept }}</td>
                <td>{{ "%.2f"|format(spending) }} UZS</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –ø–æ –æ—Ç–¥–µ–ª–∞–º.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="stats-container">
    <h2>üçΩÔ∏è –†–∞—Å—Ö–æ–¥—ã –ø–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è–º</h2>
    <div class="chart-container" style="box-shadow: none; padding: 0; margin-top: 20px;">
        <canvas id="establishmentChart"></canvas>
    </div>
    <table>
        <thead>
            <tr>
                <th>–ó–∞–≤–µ–¥–µ–Ω–∏–µ</th>
                <th>–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</th>
                <th>–î–æ–ª—è</th>
            </tr>
        </thead>
        <tbody>
            {% for item in establishment_spending_with_shares %}
            <tr>
                <td>{{ item.name }}</td>
                <td>{{ "%.2f"|format(item.spending) }} UZS</td>
                <td>{{ item.share }}%</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –ø–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è–º.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="stats-container">
    <h2>üë§ –†–∞—Å—Ö–æ–¥—ã –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h2>
    <table>
        <thead>
            <tr>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–û—Ç–¥–µ–ª</th>
                <th>–û–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</th>
            </tr>
        </thead>
        <tbody>
            {% for user_spend in user_spending_by_department %}
            <tr>
                <td>{{ user_spend.User.full_name }}</td>
                <td>{{ user_spend.department_name or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                <td>{{ "%.2f"|format(user_spend.total_spent) }} UZS</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="stats-container">
    <h2>üßæ –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–ó–∞–≤–µ–¥–µ–Ω–∏–µ</th>
                <th>–°—É–º–º–∞</th>
                <th>–¢–∏–ø</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–∞—Ç–∞</th>
            </tr>
        </thead>
        <tbody>
            {% for tx in all_transactions %}
            <tr>
                <td>{{ tx.id }}</td>
                <td>{{ tx.user.full_name }}</td>
                <td>{{ tx.establishment.name if tx.establishment else '–°–∏—Å—Ç–µ–º–Ω–∞—è' }}</td>
                <td>{{ "%.2f"|format(tx.amount) }} UZS</td>
                <td>{{ tx.type.value }}</td>
                <td>{{ tx.status.value }}</td>
                <td>{{ tx.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="download-section">
    <h2>üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç—ã</h2>
    <a href="http://localhost:8002/admin/download_stats?format=excel" class="download-btn">
        –°–∫–∞—á–∞—Ç—å –≤ Excel
    </a>
    <a href="http://localhost:8002/admin/download_stats?format=pdf" class="download-btn">
        –°–∫–∞—á–∞—Ç—å –≤ PDF
    </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('establishmentChart').getContext('2d');
    const establishmentData = JSON.parse('{{ establishment_chart_data | safe }}');
    const labels = establishmentData.map(item => item.name);
    const data = establishmentData.map(item => item.spending);

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: '–†–∞—Å—Ö–æ–¥—ã',
                data: data,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)',
                    'rgba(199, 199, 199, 0.6)', 'rgba(83, 102, 255, 0.6)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)',
                    'rgba(199, 199, 199, 1)', 'rgba(83, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: { display: false }
            }
        }
    });
</script>

{% endblock %}
